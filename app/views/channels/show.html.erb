<%- content_for :header do %>
  <%- javascript_tag do %>
    $(document).data('channelId',         <%= "'#{@channel.to_param}\'" %>)
    $(document).data('lastMessageId',     <%= "#{@messages.try(:last).try(:id) || 0}" %>)
    $(document).data('lastReadMessageId', <%= "#{@messages.try(:last).try(:id) || 0}"  %>)
    $(document).data('users',             <%= @channel.users.to_json.html_safe   || [] %>)
  <%-end %>
<%- end %>

<div class="messages">
  <%- @messages.each do |message| %>
    <div id="message_<%= message.id %>" class="message-holder <%= 'me' if current_user == message.user %>">
      <div class="message-meta">
        <span class="message-author">
          <%= "#{message.user.name}" %>
	</span>
        <span class="message-time">
          <%= "at #{message.created_at.strftime("%I:%M%p") }" %>
	</span>
	<div class = "message-content">
          <%= message.content %>
	</div>
      </div>
    </div>
  <%- end %>
</div>

<div class="sidebar">
  <div class="rooms_title">Audio</div>
  <div class="actions">
    <%= image_tag("sound-on.png", :id => "audio_toggle") %>
  </div>

  <div class="rooms_title">Files</div>
  <%= form_tag("/channels/#{@channel.to_param}/attachments.js", :remote => true, :id => "file_upload", :html => { :multipart => true }) do |form| %>
    <%= hidden_field :channel_id, @channel.id %>
    <%= file_field_tag 'file' %>
    <%= submit_tag 'Upload' %>
  <% end %>

  <ul id="file_list">
    <% @channel.attachments.order("created_at DESC").limit(15).each do |attachment| %>
    <li><a href="<%= attachment.file.url %>"><%= attachment.file_file_name and attachment.file_file_name.truncate(15) %></a></li>
    <% end %>
  </ul>

  <div class="rooms_title">Rooms</div>
  <div class="rooms">
    <%- @channels.each do |channel| %>
      <div class="room <%= "selected" if channel.id == @channel.id %>">
	<%= "#{channel.name} (#{channel.users.count})" %>
      </div>
    <%- end %>
  </div>

  <div class="users_title">Users Online</div>
  <div class="users">
    <%- @users.each do |user| %>
      <%- if user[:id] == current_user.id %>
        <div class="user selected" id="<%= "user_#{user[:id]}"%>">
      <%- else %>
        <div class="user">
      <%-end %>
        <%= "#{user[:first_name]} #{user[:last_name]}" %>
      </div>
    <%- end %>
  </div>
</div>

<%- content_for :footer do %>
  <div class="chatbox">
    <%= form_for([@channel, @message], :remote => true) do |f| %>
      <%= f.hidden_field :channel_id, :value =>  @message.channel_id %>
      <%=f.text_area :content, :rows => 20 %>
    <%- end %>
  </div>
<%-end %>
